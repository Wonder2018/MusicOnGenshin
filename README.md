# Music On Genshin

本项目适用于 `Arduino Leonardo` ，可根据乐谱自动在原神中使用乐器小道具进行演奏。

## 一、 所需材料：

1. Arduino Leonardo 或其他支持 HID 键盘及带有内置上拉电阻的 Arduino 单片机。
2. SD 卡模块（用于存放要演奏的乐谱）
3. 杜邦线若干（用于连接 SD 卡模块和短接一些特定脚位，控制演奏流程）
4. 连接 Arduino 与电脑的数据线一条
5. Arduino IDE（或其他可以烧录的 IDE ）
6. jdk 1.8 或以上版本（用于生成适合 Arduino 读取的乐谱）
7. 可以进行 Java 开发的 IDE（其实 NotePad 或者 Vim 也行，由于暂未提供打包好的 Jar，需要在 IDE 运行，或进行修改。）
8. 乐谱（<--废话）

## 二、使用方法：

1. 准备乐谱

    没有乐谱要怎么演奏啦！！

    1.1 录谱

    先将乐谱录入到一个 txt 文件，推荐使用 `utf-8` 编码。文件结构如下

    ```text

        速度,单位时值
        简谱音符，时值
        简谱音符，时值
        ...
        ...
        ...

        e.g.
        112,12      //每分钟112拍，每拍用12表示
        5,6         //第一个音符是中音 sol 半拍
        -5,3        //第一个音符是低音 sol 四分之一拍
        +5,24       //第一个音符是高音 sol 两拍

    ```

    > 注意：
    >
    > 1. 录入时用简谱录入，高音前加 `+`，低音前加 `-`。和弦写在同一行即可。例如：`-3-51,4` 表示同时按下 `低音 mi` `低音 sol` `中音 do`。
    > 2. 表示一拍的数字的指定可以比较随意，但为了方便录谱建议将乐谱中时值最短的音设置为 1，然后换算出一拍的数值，如：一份四分音符为一拍的乐谱中，出现的时值最小的音符是十六分音符，那么用 1 表示十六分音符，4 表示四分音符。如果乐谱中有三连音，可使用 3 的倍数表示一拍，这样就能准确写出三连音对应音符的时值。
    > 3. 项目中提供了一个简单的乐谱，如果你成功了，一定会听到令人愉快的声音（Doge）

    1.2 转谱

    将录好的乐谱转换成方便 Arduino 读取的格式。

    这个过程比较简单，只需将录好的乐谱命名成 `in.txt` 放到项目根目录。然后运行 `top.imwonder.musicongenshin.MusicOnGenshin` 中 `main` 方法即可。输出文件 `out` 将出现在项目根目录，控制台会显示乐谱的总拍数。你也可以在项目根目录的 `config.properties` 文件中指定乐谱文件的位置和输出文件的位置。

    > 一般情况下，IDE 会将根目录设置为运行时的 `classpath`，如果你无法完成这一步，请尝试在 `config.properties` 文件中指定绝对路径。

    1.3 存储

    将转好的乐谱文件命名为 `melody` 存在一张存储卡的根目录。储存卡的分区格式需要选择 `FAT`。

2. 准备 Arduino

    2.1 将 Arduino 用数据线连接至电脑。烧录项目中的 `Arduino/Arduino.ino` 文件。

    2.2 将 SD 卡模块连接至 Arduino。请注意，项目默认使用的 SD 卡模块`CS_PIN` 为 `4 号脚`。Leonardo 需要将 SD 卡通信脚位连接到 `ICSP` 区的针脚上。具体脚位定义为。

    ```
        □ <-- reset 按钮

        MISO--> □ □ <-- VDD(+5v)
        SCK---> □ □ <-- MOSI
        RST---> □ □ <-- GND

    ```
    2.3 连接控制线

    正常使用时，可短接 `GND` 和 `数据 8 号脚`。这样在开机并加载完乐谱后，不会立即演奏。需要演奏时，断开条线即可。需要注意的是，如果在一次演奏结束后，程序检测到 `数据 8 号脚` 未被短接，则会从头开始再演奏一遍。

    > 如果需要查看调试信息，可短接 `GND` 和 `数据 7 号脚`，这样在开机后，会等待串口被打开再进行接下类的程序。并在此过程中打印一些有用的信息。

3. 演奏

    这部分最简单了。打开游戏，装备要使用的乐器，并进入使用界面。将Arduino连接到电脑的USB口。断开 `GND` 和 `数据 8 号脚` 之间的跳线。如果一切正常，此时就能自动演奏了。

> 注意：由于 Arduino 的内存有限，一份乐谱最多只能包含 400 个音符。超过 400 个音符可能出现内存不足无法读取乐谱的情况。